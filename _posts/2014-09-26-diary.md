---
layout: post
title:  "Unicornのデーモン化とBundlerとシェルコマンド"
date:   2014-09-26 23:30:00
---

IRKit GUI 使ってて、時間を置くと反応しないことがある。  
いつもはサーバやIRKit本体を再起動して対処していたが、調べてみた。

ひとつ原因として、アプリ内部でシェルコマンドを呼び出しているから、それが Bundler 経由だとうまく呼べずに落ちているのではないかと考えた。
加えて`rbenv`で都度切り替えているため、その Ruby のバージョンでは Gem に IRKit が入ってなかったりするわけで。なので`.env`に Bundle 経由で呼び出す時のフラグつけて中で`bundle exec`をシェルコマンドの頭に付けるとかやってたんだけど、よくよく観察してみるとそもそも Bundler 経由で動いてたっていう。

foreman 経由でサーバ起動して動作確認を取って、いざデーモン化版で動かしてみると現象再発。
つまりデーモン化するときは`.env`が読み込まれないのではないか、という。わからん。

```bash
#!/bin/sh
bundle exec unicorn -p 4444 -c ./unicorn.rb -D
```

`.env`読み込んでくれないと bonjour 経由で IRKit 探せないときに不安定なんだよな〜  
というかこれがそもそもの原因だよな〜〜
